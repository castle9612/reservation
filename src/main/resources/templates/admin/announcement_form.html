<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/layout :: layout(~{::title}, ~{:: #main-content})}">
<head>
  <title th:text="${announcementDTO.id == null ? '새 공지사항 작성' : '공지사항 수정'} + ' - 예약 시스템'"></title>
  <!-- Summernote CSS (Bootstrap 4 기반) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
  <style>
    /* 레이아웃의 .container와 충돌을 피하기 위해 main-content 내부 요소에 적용 */
    #main-content .form-group { margin-bottom: 1rem; }
    #main-content .form-label { margin-bottom: .5rem; }
    #main-content .form-control {
      display: block;
      width: 100%;
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    #main-content .form-control.is-invalid { border-color: #dc3545; }
    #main-content .invalid-feedback {
      display: none; /* 기본적으로 숨김 */
      width: 100%;
      margin-top: .25rem;
      font-size: .875em;
      color: #dc3545;
    }
    #main-content .form-control.is-invalid ~ .invalid-feedback { display: block; } /* is-invalid 시 보이게 */

    #main-content .alert {
      position: relative;
      padding: .75rem 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid transparent;
      border-radius: .25rem;
    }
    #main-content .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;}
    #main-content .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb;}

    .current-attachments-list { list-style: none; padding-left: 0; }
    .current-attachments-list li { margin-bottom: 5px; display: flex; align-items: center; }
    .current-attachments-list a { margin-right: 10px; }
    .current-attachments-list button { margin-left: auto; /* 버튼을 오른쪽으로 밀착 */ }

    .note-editor.note-frame {
      border: 1px solid #ddd; /* Summernote 테두리 */
    }
    .text-danger.small { font-size: 0.875em; } /* 유효성 검사 메시지용 */

    /* 부트스트랩 버튼 스타일 (기본 레이아웃에 없을 경우 대비) */
    .btn {
      display: inline-block; font-weight: 400; color: #212529; text-align: center;
      vertical-align: middle; cursor: pointer; -webkit-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none; background-color: transparent; border: 1px solid transparent;
      padding: .375rem .75rem; font-size: 1rem; line-height: 1.5; border-radius: .25rem;
      transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    .btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }
    .btn-primary:hover { color: #fff; background-color: #0069d9; border-color: #0062cc; }
    .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
    .btn-secondary:hover { color: #fff; background-color: #5a6268; border-color: #545b62; }
    .btn-outline-danger { color: #dc3545; border-color: #dc3545; }
    .btn-outline-danger:hover { color: #fff; background-color: #dc3545; border-color: #dc3545; }
    .btn-sm { padding: .25rem .5rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; }
    .ms-2 { margin-left: .5rem !important; }
    .me-2 { margin-right: .5rem !important; }
    .mt-4 { margin-top: 1.5rem !important; }
    .d-flex { display: flex !important; }
    .justify-content-end { justify-content: flex-end !important; }
  </style>
</head>
<body>
<div id="main-content"> <!-- 레이아웃에서 main-content ID를 사용한다고 가정 -->
  <h1 th:text="${announcementDTO.id == null ? '새 공지사항 작성' : '공지사항 수정'}"></h1>

  <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
  <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

  <th:block th:with="formAction = (${announcementDTO.id == null}
                                    ? @{/admin/announcements}
                                    : @{/admin/announcements/{id}/edit(id=${announcementDTO.id})})">
    <form th:action="${formAction}"
          th:object="${announcementDTO}" method="post" enctype="multipart/form-data">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <input type="hidden" th:if="*{id != null}" th:field="*{id}" />

      <div th:if="${#fields.hasGlobalErrors()}">
        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}" class="alert alert-danger" role="alert"></p>
      </div>

      <div class="form-group"> <!-- Bootstrap 클래스 form-group 사용, mb-3는 Bootstrap 5 스타일 -->
        <label for="title" class="form-label">제목:</label>
        <input type="text" id="title" class="form-control" th:field="*{title}" required
               th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''">
        <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="invalid-feedback"></div>
      </div>

      <div class="form-group">
        <label for="summernote-content" class="form-label">내용:</label>
        <textarea id="summernote-content" class="form-control" th:field="*{content}" rows="10" required
                  th:classappend="${#fields.hasErrors('content')} ? 'is-invalid' : ''"></textarea>
        <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="invalid-feedback"></div>
      </div>

      <div class="form-group">
        <label for="newAttachmentFiles" class="form-label">새 첨부 파일 (다중 선택 가능):</label>
        <input type="file" id="newAttachmentFiles" name="newAttachmentFiles" class="form-control" multiple accept="*/*">
      </div>

      <!-- 수정 모드이고 기존 첨부 파일이 있을 경우 표시 -->
      <div th:if="*{id != null && attachmentPaths != null && !attachmentPaths.isEmpty()}" class="form-group">
        <label class="form-label">기존 첨부 파일:</label>
        <ul class="list-unstyled current-attachments-list" id="current-attachments">
          <li th:each="path, iterStat : *{attachmentPaths}" th:id="${'attachment-item-' + iterStat.index}" class="mb-1">
            <a th:href="${path}"
               th:text="${!#lists.isEmpty(announcementDTO.originalAttachmentNames) && announcementDTO.originalAttachmentNames.size() > iterStat.index ? announcementDTO.originalAttachmentNames[iterStat.index] : path.substring(path.lastIndexOf('/') + 1)}"
               th:attr="download=${!#lists.isEmpty(announcementDTO.originalAttachmentNames) && announcementDTO.originalAttachmentNames.size() > iterStat.index ? announcementDTO.originalAttachmentNames[iterStat.index] : path.substring(path.lastIndexOf('/') + 1)}"
               target="_blank"></a>
            <button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn"
                    th:data-path="${path}"
                    th:data-element-id="${'attachment-item-' + iterStat.index}">삭제</button>
          </li>
        </ul>
        <div id="deleted-paths-container">
          <!-- 삭제할 파일 경로를 위한 숨겨진 input 필드가 여기에 추가됩니다. -->
        </div>
      </div>

      <div class="form-group text-right mt-4 d-flex justify-content-end">
        <a th:href="@{/announcement/list}" class="btn btn-secondary me-2">취소</a>
        <button type="submit" class="btn btn-primary">저장하기</button>
      </div>
    </form>
  </th:block>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-ko-KR.min.js"></script>
  <script>
    alert('Pure JavaScript test: This script tag IS EXECUTING!');
    console.log('Pure JavaScript console log: This script tag IS EXECUTING!');
  </script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      console.log("Document ready! Attempting to initialize Summernote and event handlers.");
      alert("Document ready! (테스트용 alert, 확인 후 삭제하세요)"); // (0) Document ready 확인

      // Summernote 초기화
      try {
        $('#summernote-content').summernote({
          height: 350,
          minHeight: null,
          maxHeight: null,
          focus: true,
          lang: "ko-KR",
          placeholder: '내용을 입력해주세요.',
          toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
            ['fontname', ['fontname']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['height', ['height']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'video']], // 'picture'가 Summernote 이미지 업로드 버튼
            ['view', ['fullscreen', 'codeview', 'help']]
          ],
          callbacks: {
            onImageUpload : function(files) {
              console.log("Summernote onImageUpload triggered.");
              for (var i = 0; i < files.length; i++) {
                uploadSummernoteImageFile(files[i], this); // 'this'는 에디터 인스턴스
              }
            },
            onPaste: function (e) {
              var clipboardData = e.originalEvent.clipboardData;
              if (clipboardData && clipboardData.items && clipboardData.items.length) {
                var item = clipboardData.items[0];
                if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
                  e.preventDefault(); // 기본 붙여넣기 동작 방지 (base64로 이미지 삽입되는 것 등)
                  // 필요하다면 여기서 onImageUpload처럼 파일 업로드 로직을 호출할 수 있습니다.
                  // uploadSummernoteImageFile(item.getAsFile(), this);
                }
              }
            }
          }
        });
        console.log("Summernote initialized successfully.");
      } catch (e) {
        console.error("Summernote initialization failed:", e);
        alert("Summernote 초기화에 실패했습니다. 콘솔을 확인해주세요.");
      }


      // === 첨부파일 삭제 버튼 이벤트 핸들러 ===
      console.log("Attempting to register 'remove attachment' button click handler."); // (1) 핸들러 등록 시도 로그

      $('#current-attachments').on('click', '.remove-attachment-btn', function(event) {
        event.preventDefault(); // 버튼의 기본 동작 방지
        console.log("Remove button clicked! (event delegation)"); // (2) 버튼 클릭 시 로그

        const button = $(this); // 클릭된 버튼 jQuery 객체
        const filePath = button.data('path');
        const elementId = button.data('element-id');

        console.log("File Path:", filePath);
        console.log("Element ID:", elementId);
        console.log("Clicked button data attributes:", button.data());


        if (filePath && elementId) {
          removeAttachment(filePath, elementId);
        } else {
          console.error("Could not get filePath or elementId. Check button's data-* attributes.");
          console.log("Clicked button HTML:", button.prop('outerHTML'));
        }
      });

      // 페이지 로드 시 기존 첨부파일 목록 및 버튼 상태 확인 로그
      if ($('#current-attachments li').length > 0) {
        console.log("Existing attachments list found. Number of items: " + $('#current-attachments li').length);
        $('#current-attachments .remove-attachment-btn').each(function(index, btn) {
          console.log("Button " + index + " data:", $(btn).data());
        });
      } else {
        console.log("No existing attachments list found.");
      }

    }); // $(document).ready() 종료

    function uploadSummernoteImageFile(file, editor) {
      console.log("uploadSummernoteImageFile called for file:", file.name);
      let data = new FormData();
      data.append("file", file);
      const csrfToken = /*[[${_csrf.token}]]*/ $('meta[name="_csrf"]').attr('content') || /*[[${_csrf.token}]]*/ null;
      const csrfHeader = /*[[${_csrf.headerName}]]*/ $('meta[name="_csrf_header"]').attr('content') || /*[[${_csrf.headerName}]]*/ null;

      $.ajax({
        data : data,
        type : "POST",
        url : /*[[@{/admin/announcements/uploadSummernoteImageFile}]]*/ '', // CSRF 토큰은 헤더로 전송
        contentType : false,
        processData : false,
        beforeSend: function(xhr) {
          if (csrfHeader && csrfToken) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
          } else {
            console.warn("CSRF token or header not found for Summernote image upload.");
          }
        },
        success : function(response) {
          if(response.url) {
            $(editor).summernote('insertImage', response.url);
            console.log("Summernote image inserted:", response.url);
          } else if (response.error) {
            alert("Summernote 이미지 업로드 실패: " + response.error);
            console.error("Summernote image upload failed (server error):", response.error);
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error("Summernote image upload AJAX error:", textStatus, errorThrown, jqXHR.responseText);
          alert("서버 오류로 Summernote 이미지 업로드에 실패했습니다. 콘솔을 확인하세요.");
        }
      });
    }

    function removeAttachment(filePath, elementId) {
      console.log("removeAttachment function called. filePath:", filePath, "elementId:", elementId); // (3) removeAttachment 함수 호출 로그
      if (confirm("이 첨부파일을 삭제하시겠습니까? 이 작업은 저장 시 최종 반영됩니다.")) {
        console.log("Deletion confirmed for elementId:", elementId);
        $('#' + elementId).hide(); // 해당 <li> 요소를 숨김
        let hiddenInput = '<input type="hidden" name="deletedAttachmentPaths" value="' + filePath + '">';
        $('#deleted-paths-container').append(hiddenInput); // 숨겨진 input 추가
        console.log("Hidden input added:", hiddenInput);
      } else {
        console.log("Deletion cancelled.");
      }
    }
    /*]]>*/
  </script>

</div>
</body>
</html>